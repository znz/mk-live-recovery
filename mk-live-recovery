#!/bin/bash
# http://www.geekconnection.org/remastersys/info.html
set -eu

export WORKDIR=${WORKDIR:-"/tmp/_work"}
export CD_ROOT=${CD_ROOT:-"/tmp/_cd"}
export OUT_ISO=${OUT_ISO:-$WORKDIR/live-recovery-$(date '+%Y%m%d').iso}
export KERNEL_RELEASE=${KERNEL_RELEASE:-"$(uname -r)"}
export INITRD_IMG=${INITRD_IMG:-"/boot/initrd.img-$KERNEL_RELEASE"}
export VMLINUZ=${VMLINUZ:-"/boot/vmlinuz-$KERNEL_RELEASE"}
export MOUNTPOINT="${WORKDIR}/rootfs"
export FORMAT=squashfs
export FS_DIR=casper
export SFDISK_DRIVE=${SFDISK_DRIVE:-"/dev/sda"}
EXCLUDE_FILE=${EXCLUDE_FILE:-"$WORKDIR/exclude-list.txt"}

if [ -f ./common-functions ]; then
    . common-functions
else
    . /usr/share/mk-live-recovery/common-functions
fi

clean () {
    $SUDO_CMD rm -rf "${WORKDIR}"
    $SUDO_CMD rm -rf "${CD_ROOT}"
}

prepare_dir () {
    $SUDO_CMD mkdir -p "${MOUNTPOINT}"
    $SUDO_CMD mkdir -p "${CD_ROOT}"
    if [ ! -d $(dirname "$OUT_ISO") ]; then
	echo "directory not found: $(dirname "$OUT_ISO")"
	exit 1
    fi
}

prepare_exclude () {
    my_run_parts exclude live | $SUDO_CMD tee "$EXCLUDE_FILE"
}

build_root_fs () {
    local f d
    $SUDO_CMD rsync -av --delete -HAX --one-file-system --delete-excluded --exclude-from="$EXCLUDE_FILE" "/" "${MOUNTPOINT}/"

    prepare_run_parts "${MOUNTPOINT}/tmp" "root-fs"
    if [ -d scripts ]; then
        # additional scripts
	for f in scripts/*/*; do
	    d=$(dirname "$f")
	    mkdir -p "${MOUNTPOINT}/etc/initramfs-tools/$d"
	    cp -v "$f" "${MOUNTPOINT}/etc/initramfs-tools/$f"
	    chmod +x "${MOUNTPOINT}/etc/initramfs-tools/$f"
	done
    fi
    bind_mount_dev_proc
    $SUDO_CMD chroot "${MOUNTPOINT}" /bin/bash -ex <<'EOF'
export LANG=C
for f in /tmp/root-fs.d/*.sh; do
    . $f
done
EOF
    bind_umount_dev_proc
}

pack_root_fs () {
    $SUDO_CMD mkdir -p "${CD_ROOT}/${FS_DIR}"
    $SUDO_CMD rm -f "${CD_ROOT}/${FS_DIR}/filesystem.${FORMAT}"
    $SUDO_CMD mksquashfs "${MOUNTPOINT}" "${CD_ROOT}/${FS_DIR}/filesystem.${FORMAT}"
}

build_cd_boot () {
    $SUDO_CMD mkdir -p "${CD_ROOT}"/boot/grub/locale
    $SUDO_CMD cp -vp /usr/share/grub/unicode.pf2 "${CD_ROOT}/boot/grub/"
    if [ -f grub2-ja.po ]; then
	if [ ! -e grub2-ja.mo ] || [ grub2-ja.mo -ot grub2-ja.po ]; then
	    msgfmt -o grub2-ja.mo grub2-ja.po
	fi
	$SUDO_CMD cp -vp grub2-ja.mo "$CD_ROOT/boot/grub/locale/ja.mo"
    elif [ -f /boot/grub/locale/ja.mo ]; then
	$SUDO_CMD cp -vp /boot/grub/locale/ja.mo "${CD_ROOT}/boot/grub/locale/ja.mo"
    fi
    $SUDO_CMD cp -vp "${MOUNTPOINT}/boot/vmlinuz-$(uname -r)" "${CD_ROOT}/boot/vmlinuz"
    $SUDO_CMD cp -vp "${MOUNTPOINT}/boot/initrd.img-$(uname -r)" "${CD_ROOT}/boot/initrd.img"
    $SUDO_CMD cp -vp "${MOUNTPOINT}/boot/memtest86+.bin" "${CD_ROOT}/boot"

}

make_grub_cfg () {
    my_run_parts grub | $SUDO_CMD tee "${CD_ROOT}/boot/grub/grub.cfg"
}

make_cdrom_recovery () {
    $SUDO_CMD mkdir -p "${CD_ROOT}/recovery"
    $SUDO_CMD sfdisk -d "${SFDISK_DRIVE}" | $SUDO_CMD tee "${CD_ROOT}/recovery/sfdisk-d.txt"
    [ ! -d recovery ] && cd /usr/share/mk-live-recovery
    $SUDO_CMD cp -v recovery/restore.desktop "${CD_ROOT}/recovery/restore.desktop"
    $SUDO_CMD cp -v recovery/restore.sh "${CD_ROOT}/recovery/restore.sh"
    $SUDO_CMD cp -rv recovery/locale/ "${CD_ROOT}/recovery/locale/"
    $SUDO_CMD chmod +x "${CD_ROOT}/recovery/restore.sh"
}

build_iso () {
    (
        cd ${CD_ROOT} &&
        find . -name md5sum.txt -prune -o -type f -print0 |
        xargs -0 sudo md5sum |
        $SUDO_CMD tee "${CD_ROOT}/md5sum.txt"
    )
    $SUDO_CMD grub-mkrescue "--output=${OUT_ISO}" "${CD_ROOT}"
}

build () {
    prepare_dir
    prepare_exclude
    unshift_trap0_functions initd_start; initd_stop
    build_root_fs
    pack_root_fs
    build_cd_boot
    make_grub_cfg
    make_cdrom_recovery
    build_iso
}

usage () {
    cat <<USAGE
usage: $0 build
usage: $0 clean
USAGE
}

if [ "${1:+set}" = set ]; then
    set -x
    "$@"
else
    usage
    exit 1
fi
